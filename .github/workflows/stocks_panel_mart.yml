name: Stocks Panel Mart (cache-based panel + backfill status)

on:
  workflow_dispatch:
    inputs:
      sample_mode:
        description: "Sample mode for quick test (true/false)"
        type: string
        default: "false"
      sample_size:
        description: "Sample size when sample_mode=true"
        type: string
        default: "200"
      run_curations:
        description: "Run curations (true/false). Default false for scheduled runs."
        type: string
        default: "false"
      panel_start_date:
        description: "Panel start date (YYYY-MM-DD). Empty = no clamp"
        type: string
        default: ""
      panel_end_date:
        description: "Panel end date (YYYY-MM-DD). Empty = no clamp"
        type: string
        default: ""
      dart_standard_full_from:
        description: "DART standard full-range year_from (YYYY)"
        type: string
        default: "2015"
      dart_standard_full_to:
        description: "DART standard full-range year_to (YYYY)"
        type: string
        default: "2026"
  schedule:
    - cron: "0 4 * * 6"

permissions:
  contents: read
  actions: write

jobs:
  build_panel:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      PYTHONPATH: src

      STOCKS_PANEL_CACHE_NS: "v2"
      STOCKS_BACKFILL_CACHE_NS: "v2"
      MARKETCAP_CACHE_NS: "v1"

      MIN_PRICE_FILES: "2500"
      MIN_FLOWS_CURATED_FILES: "2000"
      MIN_FUND_CURATED_FILES: "2000"

      SAMPLE_MODE: ${{ github.event.inputs.sample_mode || 'false' }}
      SAMPLE_SIZE: ${{ github.event.inputs.sample_size || '200' }}
      RUN_CURATIONS: ${{ github.event.inputs.run_curations || 'false' }}

      DART_STANDARD_FULL_RANGE: "true"
      DART_STANDARD_FULL_YEAR_FROM: ${{ github.event.inputs.dart_standard_full_from || '2015' }}
      DART_STANDARD_FULL_YEAR_TO: ${{ github.event.inputs.dart_standard_full_to || '2026' }}

      PANEL_START_DATE: ${{ github.event.inputs.panel_start_date || '' }}
      PANEL_END_DATE: ${{ github.event.inputs.panel_end_date || '' }}

      PANEL_OUT_PARQUET: data/stocks/mart/panel_daily.parquet
      BACKFILL_STATUS_CSV: docs/stocks/backfill_status.csv
      BACKFILL_STATUS_MD: docs/stocks/backfill_status.md

      MARKETCAP_CURATED_BUNDLE_DIR: data/stocks/cache/marketcap_curated

    steps:
      - uses: actions/checkout@v4

      - name: Ensure cache directories exist (core)
        run: |
          mkdir -p data/stocks/master
          mkdir -p data/stocks/raw/prices data/stocks/raw/krx_flows data/stocks/raw/fundamentals
          mkdir -p data/stocks/curated
          mkdir -p docs/stocks

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --quiet --no-input -U pip
          pip install --quiet --no-input pandas pyarrow requests pykrx tabulate openpyxl

      - name: Restore cache (prefer stocks-backfill)  # ✅ core paths unified
        id: cache_restore_backfill
        uses: actions/cache/restore@v4
        with:
          path: |
            data/stocks/master
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/curated
            docs/stocks/dart_standard_*.csv
          key: stocks-backfill-${{ env.STOCKS_BACKFILL_CACHE_NS }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            stocks-backfill-${{ env.STOCKS_BACKFILL_CACHE_NS }}-${{ github.ref_name }}-
            stocks-backfill-${{ env.STOCKS_BACKFILL_CACHE_NS }}-

      - name: Restore cache (fallback stocks-panel-mart)  # ✅ core paths unified
        if: ${{ steps.cache_restore_backfill.outputs.cache-hit != 'true' }}
        id: cache_restore_panel
        uses: actions/cache/restore@v4
        with:
          path: |
            data/stocks/master
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/curated
            docs/stocks/dart_standard_*.csv
          key: stocks-panel-mart-${{ env.STOCKS_PANEL_CACHE_NS }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            stocks-panel-mart-${{ env.STOCKS_PANEL_CACHE_NS }}-${{ github.ref_name }}-
            stocks-panel-mart-${{ env.STOCKS_PANEL_CACHE_NS }}-

      - name: Restore cache (marketcap-curated bundle)
        id: cache_restore_marketcap_curated
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.MARKETCAP_CURATED_BUNDLE_DIR }}
          key: marketcap-curated-${{ env.MARKETCAP_CACHE_NS }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            marketcap-curated-${{ env.MARKETCAP_CACHE_NS }}-${{ github.ref_name }}-
            marketcap-curated-${{ env.MARKETCAP_CACHE_NS }}-

      - name: Apply marketcap-curated bundle -> data/stocks/curated
        if: always()
        run: |
          python - <<'PY'
          from pathlib import Path
          import shutil
          bundle = Path("data/stocks/cache/marketcap_curated")
          dst_root = Path("data/stocks/curated")
          if not bundle.exists():
            print("[marketcap-bundle] bundle not found:", bundle)
            raise SystemExit(0)
          n = 0
          for p in bundle.rglob("market_cap_daily.parquet"):
            rel = p.relative_to(bundle)
            dst = dst_root / rel
            dst.parent.mkdir(parents=True, exist_ok=True)
            shutil.copy2(p, dst)
            n += 1
          print(f"[marketcap-bundle] applied_files={n}")
          PY

      - name: Cache precheck summary
        if: always()
        run: |
          echo "[cache] backfill hit? -> ${{ steps.cache_restore_backfill.outputs.cache-hit }}"
          echo "[cache] panel hit?    -> ${{ steps.cache_restore_panel.outputs.cache-hit }}"
          echo "[cache] marketcap-curated hit? -> ${{ steps.cache_restore_marketcap_curated.outputs.cache-hit }}"
          python - <<'PY'
          from pathlib import Path
          def count_glob(p: Path, pat: str):
            if not p.exists(): return 0
            return len(list(p.glob(pat)))
          def count_rglob(p: Path, name: str):
            if not p.exists(): return 0
            return sum(1 for _ in p.rglob(name))
          print("[precheck] raw prices csv files =", count_glob(Path("data/stocks/raw/prices"), "*.csv"))
          print("[precheck] curated flows_daily =", count_rglob(Path("data/stocks/curated"), "flows_daily.parquet"))
          print("[precheck] curated fundamentals_daily =", count_rglob(Path("data/stocks/curated"), "fundamentals_daily.parquet"))
          PY

      - name: Sanity gate (prices/flows/fund coverage)
        id: sanity
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          def count_glob(p: Path, pat: str):
            if not p.exists(): return 0
            return len(list(p.glob(pat)))

          def count_rglob(p: Path, name: str):
            if not p.exists(): return 0
            return sum(1 for _ in p.rglob(name))

          n_price = count_glob(Path("data/stocks/raw/prices"), "*.csv")
          n_flows_cur = count_rglob(Path("data/stocks/curated"), "flows_daily.parquet")
          n_fund_cur  = count_rglob(Path("data/stocks/curated"), "fundamentals_daily.parquet")

          min_price = int(os.environ["MIN_PRICE_FILES"])
          min_flows = int(os.environ["MIN_FLOWS_CURATED_FILES"])
          min_fund  = int(os.environ["MIN_FUND_CURATED_FILES"])

          print(f"[sanity] price_csv_files={n_price} (min={min_price})")
          print(f"[sanity] flows_curated_files={n_flows_cur} (min={min_flows})")
          print(f"[sanity] fund_curated_files={n_fund_cur} (min={min_fund})")

          if n_price < min_price:
            raise SystemExit("[sanity] TOO_FEW_PRICES -> STOP (run stock_backfill v2)")
          if n_flows_cur < min_flows:
            raise SystemExit("[sanity] TOO_FEW_FLOWS_CURATED -> STOP (run stock_backfill v2)")
          if n_fund_cur < min_fund:
            raise SystemExit("[sanity] TOO_FEW_FUND_CURATED -> STOP (run stock_backfill v2)")

          print("[sanity] OK")
          PY

      - name: Fetch listings (KOSPI+KOSDAQ)
        run: python src/stocks/fetch_listings.py

      - name: Build WICS map (wics_map.parquet)
        run: python src/stocks/build_wics_map.py

      - name: Curate (flows/fundamentals/dart/marketcap) - optional
        if: ${{ env.RUN_CURATIONS == 'true' }}
        continue-on-error: true
        run: |
          python src/stocks/curate_flows.py || echo "⚠ curate_flows error"
          python src/stocks/curate_fundamentals.py || echo "⚠ curate_fundamentals error"
          python src/stocks/curate_market_cap.py || echo "⚠ curate_market_cap error"
          python src/stocks/curate_dart.py || echo "⚠ curate_dart error"

      - name: Build merged 1-file panel parquet
        run: |
          python src/stocks/build_panel_merged.py
          ls -lh data/stocks/mart/panel_daily.parquet

      - name: Backfill status report (csv + md)
        run: |
          python src/stocks/report_backfill_status.py
          ls -lh docs/stocks/backfill_status.*

      - name: Save cache (panel_mart) ✅ only when sanity OK  # ✅ core paths unified
        if: ${{ success() && steps.sanity.outcome == 'success' }}
        uses: actions/cache/save@v4
        with:
          path: |
            data/stocks/master
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/curated
            docs/stocks/dart_standard_*.csv
          key: stocks-panel-mart-${{ env.STOCKS_PANEL_CACHE_NS }}-${{ github.ref_name }}-${{ github.run_id }}

      - name: Upload panel + reports (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stocks-panel-mart
          path: |
            data/stocks/mart/panel_daily.parquet
            docs/stocks/backfill_status.csv
            docs/stocks/backfill_status.md
          retention-days: 30
          if-no-files-found: warn
