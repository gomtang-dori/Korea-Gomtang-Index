name: Stock Backfill (Full History)

on:
  workflow_dispatch:
    inputs:
      skip_prices:
        description: 'Skip price data fetch'
        type: boolean
        default: false
      skip_flows:
        description: 'Skip flows data fetch'
        type: boolean
        default: false
      skip_dart:
        description: 'Skip DART data fetch'
        type: boolean
        default: false

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 330  # 5.5ì‹œê°„
    env:
      DART_API_KEY: ${{ secrets.DART_API_KEY }}
      SAMPLE_MODE: "false"
      MAX_WORKERS: "20"
      INCREMENTAL_MODE: "false"

    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: pip install pandas pyarrow pykrx requests plotly
      
      # âœ… ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ë¥¼ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ (cd src/stocks ì œê±°)
      
      - name: "[1/9] Fetch listings (2771 stocks)"
        continue-on-error: true
        run: |
          python src/stocks/fetch_listings.py || echo "âš ï¸ ë§ˆìŠ¤í„° ëª©ë¡ ì˜¤ë¥˜"
      
      - name: "[2/9] Fetch prices (30~60ë¶„)"
        if: ${{ !inputs.skip_prices }}
        continue-on-error: true
        run: |
          echo "â±ï¸  ì˜ˆìƒ ì†Œìš”: 30~60ë¶„ (ë³‘ë ¬ 20 workers)"
          python src/stocks/fetch_prices.py || echo "âš ï¸ ê°€ê²© ë°ì´í„° ì¼ë¶€ ì˜¤ë¥˜"
      
      - name: "[3/9] Fetch KRX flows (60~90ë¶„)"
        if: ${{ !inputs.skip_flows }}
        continue-on-error: true
        run: |
          echo "â±ï¸  ì˜ˆìƒ ì†Œìš”: 60~90ë¶„ (ë³‘ë ¬ 20 workers)"
          python src/stocks/fetch_krx_flows.py || echo "âš ï¸ ìˆ˜ê¸‰ ë°ì´í„° ì¼ë¶€ ì˜¤ë¥˜"
      
      - name: "[4/9] Fetch DART financials (30~60ë¶„)"
        if: ${{ !inputs.skip_dart }}
        continue-on-error: true
        run: |
          echo "â±ï¸  ì˜ˆìƒ ì†Œìš”: 30~60ë¶„ (ë³‘ë ¬ 5 workers, DART API rate limit)"
          python src/stocks/fetch_dart_financials.py || echo "âš ï¸ DART ë°ì´í„° ì¼ë¶€ ì˜¤ë¥˜"
      
      # âœ… ì¤‘ê°„ ì €ìž¥ 1: Raw ë°ì´í„° ë°±ì—…
      - name: "[ì¤‘ê°„ ì €ìž¥ 1] Raw ë°ì´í„° ë°±ì—…"
        continue-on-error: true
        run: |
          echo "=== ì¤‘ê°„ ì €ìž¥ $(date) ==="
          du -sh data/stocks/ || true
          tar -czf raw_data_backup.tar.gz data/stocks/raw/ || true
      
      - name: "[ì¤‘ê°„ ì €ìž¥ 1-1] Raw ë°ì´í„° ì—…ë¡œë“œ"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: raw-data-backup
          path: raw_data_backup.tar.gz
          retention-days: 7
          if-no-files-found: warn
      
      - name: "[5/9] Curate financials"
        continue-on-error: true
        run: |
          python src/stocks/curate_financials.py || echo "âš ï¸ ìž¬ë¬´ íë ˆì´ì…˜ ì¼ë¶€ ì˜¤ë¥˜"
      
      - name: "[6/9] Curate flows"
        continue-on-error: true
        run: |
          python src/stocks/curate_flows.py || echo "âš ï¸ ìˆ˜ê¸‰ íë ˆì´ì…˜ ì¼ë¶€ ì˜¤ë¥˜"
      
      - name: "[7/9] Compute features"
        continue-on-error: true
        run: |
          python src/stocks/compute_features.py || echo "âš ï¸ Features ê³„ì‚° ì¼ë¶€ ì˜¤ë¥˜"
      
      # âœ… ì¤‘ê°„ ì €ìž¥ 2: Curated ë°ì´í„° ì»¤ë°‹
      - name: "[ì¤‘ê°„ ì €ìž¥ 2] Curated ë°ì´í„° ì»¤ë°‹"
        continue-on-error: true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add data/stocks/master/ || true
          git add data/stocks/curated/ || true
          git add data/stocks/analysis/ || true
          
          git diff --staged --quiet || \
            git commit -m "Backfill WIP: curated data ($(date +%Y%m%d_%H%M))" || true
          
          git push || echo "âš ï¸ Git push ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
      
      - name: "[8/9] Render reports (2771 stocks)"
        continue-on-error: true
        run: |
          python src/stocks/render_stock_report.py || echo "âš ï¸ ë¦¬í¬íŠ¸ ìƒì„± ì¼ë¶€ ì˜¤ë¥˜"
      
      - name: "[9/9] Export CSV summaries"
        continue-on-error: true
        run: |
          python src/stocks/export_data_summary.py || echo "âš ï¸ CSV ì¶œë ¥ ì¼ë¶€ ì˜¤ë¥˜"

      # âœ… ì¶”ê°€: Raw ë°ì´í„° CSV ì¶”ì¶œ
      - name: "[10/10] Export raw data to CSV"
        continue-on-error: true
        run: |
          echo "â±ï¸  ì˜ˆìƒ ì†Œìš”: 5~10ë¶„ (ëŒ€ìš©ëŸ‰ CSV ìƒì„±)"
          python src/stocks/export_raw_to_csv.py || echo "âš ï¸ Raw CSV ì¶œë ¥ ì¼ë¶€ ì˜¤ë¥˜"      
          
      # âœ… ìµœì¢… ê²°ê³¼ í™•ì¸
      - name: "Check results"
        if: always()
        run: |
          echo "=== ìµœì¢… ê²°ê³¼ ==="
          echo "ë°ì´í„° ìš©ëŸ‰:"
          du -sh data/stocks/ 2>/dev/null || echo "data ì—†ìŒ"
          du -sh docs/stocks/ 2>/dev/null || echo "docs ì—†ìŒ"
          
          echo ""
          echo "ìƒì„±ëœ íŒŒì¼:"
          ls -lh docs/stocks/*.html 2>/dev/null | head -5 || echo "HTML ì—†ìŒ"
          ls -lh docs/stocks/*.csv 2>/dev/null || echo "CSV ì—†ìŒ"
          
          echo ""
          echo "ì¢…ëª© ìˆ˜ í†µê³„:"
          echo "  ê°€ê²©: $(ls data/stocks/raw/prices/ 2>/dev/null | wc -l)"
          echo "  ìˆ˜ê¸‰: $(ls data/stocks/raw/krx_flows/ 2>/dev/null | wc -l)"
          echo "  DART: $(ls data/stocks/raw/dart/ 2>/dev/null | wc -l)"
          echo "  HTML: $(ls docs/stocks/*.html 2>/dev/null | wc -l)"
          echo "  CSV: $(ls docs/stocks/*.csv 2>/dev/null | wc -l)"
      
      # âœ… Artifacts ì—…ë¡œë“œ
      - name: "Upload HTML reports (ìƒ˜í”Œ 100ê°œ)"
        if: always()
        run: |
          mkdir -p upload_html
          ls docs/stocks/*.html 2>/dev/null | head -100 | xargs -I {} cp {} upload_html/ || true
          cp docs/stocks/index.html upload_html/ 2>/dev/null || true
      
      - name: "Upload HTML artifact"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backfill-html-sample
          path: upload_html/
          retention-days: 30
          if-no-files-found: warn
      
      - name: "Upload CSV reports"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backfill-csv-reports
          path: docs/stocks/*.csv
          retention-days: 90
          if-no-files-found: warn
          
      # âœ… Raw CSV Artifacts ì—…ë¡œë“œ ì¶”ê°€
      - name: "Upload raw data CSVs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: raw-data-csvs
          path: |
            docs/stocks/prices_raw.csv
            docs/stocks/flows_raw.csv
            docs/stocks/financials_raw.csv
          retention-days: 30
          if-no-files-found: warn      
          
      - name: "Upload master summary"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: master-summary
          path: docs/stocks/master_summary.csv
          retention-days: 90
          if-no-files-found: warn
      
      # âœ… ìµœì¢… ì»¤ë°‹
      - name: "Final commit (curated + reports)"
        if: always()
        continue-on-error: true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # curated + analysis + reports ì»¤ë°‹ (raw ì œì™¸)
          git add data/stocks/master/ || true
          git add data/stocks/curated/ || true
          git add data/stocks/analysis/ || true
          git add docs/stocks/*.csv || true
          git add docs/stocks/index.html || true
          
          git diff --staged --quiet || \
            git commit -m "Backfill complete: curated data + reports ($(date +%Y%m%d))" || true
          
          git push || echo "âš ï¸ Final push ì‹¤íŒ¨"
      
      # âœ… ë°±í•„ ìš”ì•½ ë¦¬í¬íŠ¸
      - name: "Generate backfill summary"
        if: always()
        run: |
          cat > backfill_summary.txt <<EOF
          ===================================
          ë°±í•„ ì™„ë£Œ ë¦¬í¬íŠ¸
          ===================================
          ì™„ë£Œ ì‹œê°„: $(date)
          
          ðŸ“Š ë°ì´í„° í†µê³„:
          - ê°€ê²© ë°ì´í„°: $(ls data/stocks/raw/prices/ 2>/dev/null | wc -l) ì¢…ëª©
          - ìˆ˜ê¸‰ ë°ì´í„°: $(ls data/stocks/raw/krx_flows/ 2>/dev/null | wc -l) ì¢…ëª©
          - DART ë°ì´í„°: $(ls data/stocks/raw/dart/ 2>/dev/null | wc -l) ì¢…ëª©
          - Features: $(ls data/stocks/analysis/ 2>/dev/null | wc -l) ì¢…ëª©
          - HTML ë¦¬í¬íŠ¸: $(ls docs/stocks/*.html 2>/dev/null | wc -l) ê°œ
          - CSV íŒŒì¼: $(ls docs/stocks/*.csv 2>/dev/null | wc -l) ê°œ
          
          ðŸ’¾ ë””ë ‰í† ë¦¬ ìš©ëŸ‰:
          $(du -sh data/stocks/raw/ 2>/dev/null || echo "raw: N/A")
          $(du -sh data/stocks/curated/ 2>/dev/null || echo "curated: N/A")
          $(du -sh data/stocks/analysis/ 2>/dev/null || echo "analysis: N/A")
          $(du -sh docs/stocks/ 2>/dev/null || echo "docs: N/A")
          
          ðŸ“ˆ ì™„ë£Œìœ¨:
          $(python3 -c "
          import pandas as pd
          from pathlib import Path
          try:
              df = pd.read_csv('docs/stocks/master_summary.csv')
              complete = (df['has_features']==True).sum()
              total = len(df)
              print(f'ë°ì´í„° ì™„ë£Œ: {complete}/{total} ({complete/total*100:.1f}%)')
          except:
              print('ì™„ë£Œìœ¨ ê³„ì‚° ë¶ˆê°€')
          " 2>/dev/null || echo "ì™„ë£Œìœ¨: N/A")
          
          ===================================
          EOF
          
          cat backfill_summary.txt
      
      - name: "Upload backfill summary"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backfill-summary
          path: backfill_summary.txt
          retention-days: 90
          if-no-files-found: warn
