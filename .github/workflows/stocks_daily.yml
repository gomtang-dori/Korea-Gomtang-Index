name: Stocks Daily (10D incremental + panel_5y + report)
#매일(평일) 자동 실행 + 수동 실행
#최근 10일 증분 수집
#panel_5y.parquet 덮어쓰기 생성
#docs/stocks 리포트 갱신 + 커밋/푸시
#LFS 사용(체크아웃/푸시)
on:
  workflow_dispatch:
    inputs:
      incremental_days:
        description: "Incremental days"
        type: string
        default: "10"
  schedule:
    # Weekdays 07:10 UTC (조정 가능)
    - cron: "10 7 * * 1-5"

permissions:
  contents: write

jobs:
  daily:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      INCREMENTAL_MODE: "true"
      INCREMENTAL_DAYS: ${{ inputs.incremental_days || '10' }}

      MAX_WORKERS: "10"
      MAX_WORKERS_FLOWS: "4"
      MAX_WORKERS_FUNDAMENTALS: "6"
      KRX_THROTTLE_SEC: "0.10"

      # curate 기본값은 스크립트에 이미 존재
      FLOW_INCLUDE_BUYSELL: "true"

      # panel build
      PANEL_SCOPE: "5y"
      DART_STD_PATH: "docs/stocks/dart_standard_2015_2026.csv"
      PANEL_PARQUET_COMPRESSION: "zstd"

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install git-lfs
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y git-lfs
          git lfs install

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install pandas pyarrow requests pykrx

      # 캐시(누적) - 필요 최소만
      - name: Restore cache (prices/flows/fund/curated/analysis)
        uses: actions/cache/restore@v4
        with:
          path: |
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/curated
            data/stocks/analysis
          key: stocks-daily-v1-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            stocks-daily-v1-${{ github.ref_name }}-
            stocks-daily-v1-

      - name: Fetch listings (master)
        env:
          SAMPLE_MODE: "false"
        run: python src/stocks/fetch_listings.py

      - name: Fetch prices (10D incremental)
        run: python src/stocks/fetch_prices.py

      - name: Fetch KRX flows (10D incremental)
        run: python src/stocks/fetch_krx_flows.py

      - name: Fetch fundamentals (10D incremental)
        run: python src/stocks/fetch_fundamentals.py

      - name: Curate flows
        run: python src/stocks/curate_flows.py

      - name: Curate fundamentals
        run: python src/stocks/curate_fundamentals.py

      - name: Build panel parquet (5y overwrite)
        run: python src/stocks/build_panel_parquet.py

      - name: Verify panel health (5y)
        env:
          PANEL_SCOPE: "5y"
        run: python src/stocks/verify_panel_health.py

      - name: Compute features
        run: python src/stocks/compute_features.py

      - name: Render stock report
        run: python src/stocks/render_stock_report.py

      - name: Export summary CSVs
        run: python src/stocks/export_data_summary.py

      - name: Save cache (prices/flows/fund/curated/analysis)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/curated
            data/stocks/analysis
          key: stocks-daily-v1-${{ github.ref_name }}-${{ github.run_id }}

      - name: Commit & push (panel_5y + docs)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/stocks/mart/panel_5y.parquet || true
          git add docs/stocks || true

          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "stocks daily: update panel_5y + docs"
          git push
