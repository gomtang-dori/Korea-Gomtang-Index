name: Stocks Daily (Incremental + panel_daily + report + column check)

on:
  workflow_dispatch:
    inputs:
      incremental_days:
        description: "Incremental days"
        type: string
        default: "10"
  schedule:
    - cron: "10 7 * * 1-5"

permissions:
  contents: write
  issues: write
  actions: write

concurrency:
  group: stocks-daily-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  daily:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      INCREMENTAL_MODE: "true"
      INCREMENTAL_DAYS: ${{ inputs.incremental_days || '10' }}

      STOCKS_BACKFILL_CACHE_NS: "v2"
      STOCKS_DAILY_CACHE_NS: "v2"

      MIN_PRICE_FILES: "2500"
      MIN_FLOWS_CURATED_FILES: "2000"
      MIN_FUND_CURATED_FILES: "2000"

      MAX_WORKERS: "10"
      MAX_WORKERS_FLOWS: "3"
      MAX_WORKERS_FUNDAMENTALS: "6"
      KRX_THROTTLE_SEC: "0.15"

      FLOW_INCLUDE_BUYSELL: "true"

      PANEL_SCOPE: "5y"
      DART_STD_PATH: "docs/stocks/dart_standard_2015_2026.csv"
      PANEL_PARQUET_COMPRESSION: "zstd"
      PANEL_DAILY_PATH: "data/stocks/mart/panel_daily.parquet"
      PANEL_COL_CHECK_TXT: "docs/stocks/panel_cols_check.txt"

      MARKETCAP_MODE: "recent"
      MARKETCAP_TRADING_DAYS: "15"
      MARKETCAP_MAX_BACKTRACK_DAYS: "40"
      MARKETCAP_THROTTLE_SEC: "0.20"
      MARKETCAP_OVERWRITE: "false"
      MARKETCAP_OUT_DIR: "data/stocks/raw/market_cap_by_date"
      MARKETCAP_COMPRESSION: "zstd"

      MARKETCAP_CACHE_NS: "v1"
      MARKETCAP_CURATED_BUNDLE_DIR: "data/stocks/cache/marketcap_curated"

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install git-lfs
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y git-lfs
          git lfs install

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --quiet --no-input -U pip
          pip install --quiet --no-input pandas pyarrow requests pykrx tabulate openpyxl

      - name: Restore cache (prefer backfill)
        id: cache_restore_backfill
        uses: actions/cache/restore@v4
        with:
          path: |
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/raw/market_cap_by_date
            data/stocks/curated
            data/stocks/analysis
            docs/stocks/dart_standard_*.csv
          key: stocks-backfill-${{ env.STOCKS_BACKFILL_CACHE_NS }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            stocks-backfill-${{ env.STOCKS_BACKFILL_CACHE_NS }}-${{ github.ref_name }}-
            stocks-backfill-${{ env.STOCKS_BACKFILL_CACHE_NS }}-

      - name: Restore cache (fallback daily)
        if: ${{ steps.cache_restore_backfill.outputs.cache-hit != 'true' }}
        id: cache_restore_daily
        uses: actions/cache/restore@v4
        with:
          path: |
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/raw/market_cap_by_date
            data/stocks/curated
            data/stocks/analysis
            docs/stocks/dart_standard_*.csv
          key: stocks-daily-${{ env.STOCKS_DAILY_CACHE_NS }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            stocks-daily-${{ env.STOCKS_DAILY_CACHE_NS }}-${{ github.ref_name }}-
            stocks-daily-${{ env.STOCKS_DAILY_CACHE_NS }}-

      - name: Restore cache (marketcap-curated bundle)
        id: cache_restore_marketcap_curated
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.MARKETCAP_CURATED_BUNDLE_DIR }}
          key: marketcap-curated-${{ env.MARKETCAP_CACHE_NS }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            marketcap-curated-${{ env.MARKETCAP_CACHE_NS }}-${{ github.ref_name }}-
            marketcap-curated-${{ env.MARKETCAP_CACHE_NS }}-

      - name: Apply marketcap-curated bundle -> data/stocks/curated
        if: always()
        run: |
          python - <<'PY'
          from pathlib import Path
          import shutil
          bundle = Path("data/stocks/cache/marketcap_curated")
          dst_root = Path("data/stocks/curated")
          if not bundle.exists():
            print("[marketcap-bundle] bundle not found (first run is OK):", bundle)
            raise SystemExit(0)
          n = 0
          for p in bundle.rglob("market_cap_daily.parquet"):
            rel = p.relative_to(bundle)
            dst = dst_root / rel
            dst.parent.mkdir(parents=True, exist_ok=True)
            shutil.copy2(p, dst)
            n += 1
          print(f"[marketcap-bundle] applied_files={n}")
          PY

      - name: Cache precheck summary
        if: always()
        run: |
          echo "[cache] backfill hit? -> ${{ steps.cache_restore_backfill.outputs.cache-hit }}"
          echo "[cache] daily hit?    -> ${{ steps.cache_restore_daily.outputs.cache-hit }}"
          echo "[cache] marketcap-curated hit? -> ${{ steps.cache_restore_marketcap_curated.outputs.cache-hit }}"
          python - <<'PY'
          from pathlib import Path
          def count_glob(p: Path, pat: str):
            if not p.exists(): return 0
            return len(list(p.glob(pat)))
          def count_rglob(p: Path, name: str):
            if not p.exists(): return 0
            return sum(1 for _ in p.rglob(name))
          print("[precheck] raw prices csv files =", count_glob(Path("data/stocks/raw/prices"), "*.csv"))
          print("[precheck] curated flows_daily =", count_rglob(Path("data/stocks/curated"), "flows_daily.parquet"))
          print("[precheck] curated fundamentals_daily =", count_rglob(Path("data/stocks/curated"), "fundamentals_daily.parquet"))
          print("[precheck] curated market_cap_daily =", count_rglob(Path("data/stocks/curated"), "market_cap_daily.parquet"))
          PY

      - name: Sanity gate (prices/flows/fund coverage)
        id: sanity
        run: |
          python - <<'PY'
          import os
          from pathlib import Path
          def count_glob(p: Path, pat: str):
            if not p.exists(): return 0
            return len(list(p.glob(pat)))
          def count_rglob(p: Path, name: str):
            if not p.exists(): return 0
            return sum(1 for _ in p.rglob(name))
          n_price = count_glob(Path("data/stocks/raw/prices"), "*.csv")
          n_flows_cur = count_rglob(Path("data/stocks/curated"), "flows_daily.parquet")
          n_fund_cur  = count_rglob(Path("data/stocks/curated"), "fundamentals_daily.parquet")
          min_price = int(os.environ["MIN_PRICE_FILES"])
          min_flows = int(os.environ["MIN_FLOWS_CURATED_FILES"])
          min_fund  = int(os.environ["MIN_FUND_CURATED_FILES"])
          print(f"[sanity] price_csv_files={n_price} (min={min_price})")
          print(f"[sanity] flows_curated_files={n_flows_cur} (min={min_flows})")
          print(f"[sanity] fund_curated_files={n_fund_cur} (min={min_fund})")
          if n_price < min_price:
            raise SystemExit("[sanity] TOO_FEW_PRICES -> STOP (run stock_backfill v2)")
          if n_flows_cur < min_flows:
            raise SystemExit("[sanity] TOO_FEW_FLOWS_CURATED -> STOP (run stock_backfill v2)")
          if n_fund_cur < min_fund:
            raise SystemExit("[sanity] TOO_FEW_FUND_CURATED -> STOP (run stock_backfill v2)")
          print("[sanity] OK")
          PY

      - name: Fetch listings (master)
        env:
          SAMPLE_MODE: "false"
        run: python src/stocks/fetch_listings.py

      - name: Fetch prices (incremental)
        run: python src/stocks/fetch_prices.py

      - name: Fetch KRX flows (incremental)
        run: python src/stocks/fetch_krx_flows.py

      - name: Fetch fundamentals (incremental)
        run: python src/stocks/fetch_fundamentals.py

      - name: Curate flows
        run: python src/stocks/curate_flows.py

      - name: Curate fundamentals
        run: python src/stocks/curate_fundamentals.py

      - name: Build WICS map (wics_map.parquet)
        run: python src/stocks/build_wics_map.py

      - name: Fetch market cap by date (recent)
        run: python src/stocks/fetch_market_cap_by_date.py

      - name: Curate market cap (per ticker)
        run: python src/stocks/curate_market_cap.py

      - name: Rebuild marketcap curated cache bundle (from data/stocks/curated)
        if: always()
        run: |
          python - <<'PY'
          from pathlib import Path
          import shutil
          src_root = Path("data/stocks/curated")
          out_root = Path("data/stocks/cache/marketcap_curated")
          if out_root.exists():
            shutil.rmtree(out_root)
          out_root.mkdir(parents=True, exist_ok=True)
          n = 0
          for p in src_root.rglob("market_cap_daily.parquet"):
            rel = p.relative_to(src_root)
            dst = out_root / rel
            dst.parent.mkdir(parents=True, exist_ok=True)
            shutil.copy2(p, dst)
            n += 1
          print(f"[bundle] copied_files={n}")
          PY

      - name: Save cache (marketcap-curated bundle) ✅ only when sanity OK
        if: ${{ success() && steps.sanity.outcome == 'success' }}
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.MARKETCAP_CURATED_BUNDLE_DIR }}
          key: marketcap-curated-${{ env.MARKETCAP_CACHE_NS }}-${{ github.ref_name }}-${{ github.run_id }}

      - name: Build panel parquet (5y scope -> panel_daily.parquet)
        env:
          PANEL_SCOPE: "5y"
          PANEL_OUT_PATH: ${{ env.PANEL_DAILY_PATH }}
        run: |
          python src/stocks/build_panel_parquet.py
          ls -lh "${PANEL_DAILY_PATH}" || true

      - name: Upload panel_daily.parquet (artifact, retention 30d)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: panel-daily-parquet
          path: |
            ${{ env.PANEL_DAILY_PATH }}
          retention-days: 30
          if-no-files-found: warn

      - name: Verify panel health (5y, file=panel_daily)
        env:
          PANEL_SCOPE: "5y"
          PANEL_PATH: ${{ env.PANEL_DAILY_PATH }}
        run: python src/stocks/verify_panel_health.py

      - name: Check panel_daily columns
        run: |
          python src/stocks/check_panel_cols.py "${PANEL_DAILY_PATH}" | tee "${PANEL_COL_CHECK_TXT}"

      - name: Save cache (prices/flows/fund/marketcap/raw+curated/analysis) ✅ only when sanity OK
        if: ${{ success() && steps.sanity.outcome == 'success' }}
        uses: actions/cache/save@v4
        with:
          path: |
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/raw/market_cap_by_date
            data/stocks/curated
            data/stocks/analysis
            docs/stocks/dart_standard_*.csv
          key: stocks-daily-${{ env.STOCKS_DAILY_CACHE_NS }}-${{ github.ref_name }}-${{ github.run_id }}

      - name: Commit & push (docs only) ✅ only when sanity OK
        if: ${{ success() && steps.sanity.outcome == 'success' }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/stocks || true
          git diff --cached --quiet && echo "No docs changes" && exit 0
          git commit -m "stocks daily: update docs"
          git push
