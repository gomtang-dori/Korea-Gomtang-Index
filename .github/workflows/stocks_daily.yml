name: Stocks Daily (Incremental + panel_daily + report)

# 평일(거래일) 자동 실행 + 수동 실행
# 최근 N일 증분 수집 → curate → panel_daily.parquet 덮어쓰기(재생성) → docs 갱신 → 커밋/푸시
# LFS 사용(체크아웃/푸시)

on:
  workflow_dispatch:
    inputs:
      incremental_days:
        description: "Incremental days"
        type: string
        default: "10"
  schedule:
    # Weekdays 07:10 UTC
    - cron: "10 7 * * 1-5"

permissions:
  contents: write

# 동시에 여러 번 돌아가며 커밋/캐시 충돌 나는 것을 방지
concurrency:
  group: stocks-daily-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  daily:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      INCREMENTAL_MODE: "true"
      INCREMENTAL_DAYS: ${{ inputs.incremental_days || '10' }}

      # 안정 설정(보수적으로)
      MAX_WORKERS: "10"
      MAX_WORKERS_FLOWS: "3"
      MAX_WORKERS_FUNDAMENTALS: "6"
      KRX_THROTTLE_SEC: "0.15"

      # curate 옵션(스크립트 기본값도 존재)
      FLOW_INCLUDE_BUYSELL: "true"

      # panel build
      PANEL_SCOPE: "5y"
      DART_STD_PATH: "docs/stocks/dart_standard_2015_2026.csv"
      PANEL_PARQUET_COMPRESSION: "zstd"

      # panel output (단일 패널 파일로 통일)
      PANEL_DAILY_PATH: "data/stocks/mart/panel_daily.parquet"

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install git-lfs
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y git-lfs
          git lfs install

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --quiet --no-input -U pip
          pip install --quiet --no-input pandas pyarrow requests pykrx tabulate

      # ------------------------------------------------------------
      # 캐시 복원 (우선 backfill 캐시 → 없으면 daily 캐시)
      # backfill을 먼저 복원해야 "2022~2026 seed 데이터 위에 최신 N일만 추가"가 안정적으로 동작
      # ------------------------------------------------------------
      - name: Restore cache (prefer backfill)
        id: cache_restore_backfill
        uses: actions/cache/restore@v4
        with:
          path: |
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/curated
            data/stocks/analysis
            docs/stocks/dart_standard_*.csv
          # backfill 워크플로우 키가 레포에서 여러 형태일 수 있어, restore-keys를 넓게 잡습니다.
          key: stocks-backfill-v1-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            stocks-backfill-v1-${{ github.ref_name }}-
            stocks-backfill-v1-
            stocks-backfill-${{ github.ref_name }}-
            stocks-backfill-

      - name: Restore cache (fallback daily)
        if: ${{ steps.cache_restore_backfill.outputs.cache-hit != 'true' }}
        id: cache_restore_daily
        uses: actions/cache/restore@v4
        with:
          path: |
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/curated
            data/stocks/analysis
            docs/stocks/dart_standard_*.csv
          key: stocks-daily-v1-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            stocks-daily-v1-${{ github.ref_name }}-
            stocks-daily-v1-

      - name: Cache precheck summary
        if: always()
        run: |
          echo "[cache] backfill hit? -> ${{ steps.cache_restore_backfill.outputs.cache-hit }}"
          echo "[cache] daily hit?    -> ${{ steps.cache_restore_daily.outputs.cache-hit }}"
          python - <<'PY'
          from pathlib import Path

          def count_files(p: Path, glob_pat: str):
            if not p.exists():
              return 0
            return sum(1 for _ in p.rglob(glob_pat))

          prices = Path("data/stocks/raw/prices")
          flows  = Path("data/stocks/raw/krx_flows")
          fund   = Path("data/stocks/raw/fundamentals")
          curated= Path("data/stocks/curated")
          docs   = Path("docs/stocks")

          print("[precheck] prices_csv_files =", count_files(prices, "*.csv"))
          print("[precheck] flows_parquet_files =", count_files(flows, "*.parquet"))
          print("[precheck] fundamentals_parquet_files =", count_files(fund, "*.parquet"))
          print("[precheck] curated_flows_daily =", count_files(curated, "flows_daily.parquet"))
          print("[precheck] curated_fundamentals_daily =", count_files(curated, "fundamentals_daily.parquet"))
          print("[precheck] dart_standard_csv =", count_files(docs, "dart_standard_*.csv"))
          PY

      - name: Fetch listings (master)
        env:
          SAMPLE_MODE: "false"
        run: python src/stocks/fetch_listings.py

      - name: Fetch prices (incremental)
        run: python src/stocks/fetch_prices.py

      - name: Fetch KRX flows (incremental)
        run: python src/stocks/fetch_krx_flows.py

      - name: Fetch fundamentals (incremental)
        run: python src/stocks/fetch_fundamentals.py

      - name: Curate flows
        run: python src/stocks/curate_flows.py

      - name: Curate fundamentals
        run: python src/stocks/curate_fundamentals.py

      # ------------------------------------------------------------
      # 단일 패널 생성: panel_daily.parquet 로 통일 (내용은 5y 스코프 유지)
      # build_panel_parquet.py 는 PANEL_OUT_PATH로 출력 경로 override 가능
      # ------------------------------------------------------------
      - name: Build panel parquet (5y scope -> panel_daily.parquet)
        env:
          PANEL_SCOPE: "5y"
          PANEL_OUT_PATH: ${{ env.PANEL_DAILY_PATH }}
        run: |
          python src/stocks/build_panel_parquet.py
          ls -lh data/stocks/mart || true
          ls -lh "${PANEL_DAILY_PATH}" || true

      # health check도 panel_daily를 검사하도록 PANEL_PATH 지정
      - name: Verify panel health (5y, file=panel_daily)
        env:
          PANEL_SCOPE: "5y"
          PANEL_PATH: ${{ env.PANEL_DAILY_PATH }}
        run: python src/stocks/verify_panel_health.py

      - name: Compute features
        run: python src/stocks/compute_features.py

      - name: Render stock report
        run: python src/stocks/render_stock_report.py

      - name: Export summary CSVs
        run: python src/stocks/export_data_summary.py

      # 캐시 저장(매일 누적)
      - name: Save cache (prices/flows/fund/curated/analysis)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            data/stocks/raw/prices
            data/stocks/raw/krx_flows
            data/stocks/raw/fundamentals
            data/stocks/curated
            data/stocks/analysis
            docs/stocks/dart_standard_*.csv
          key: stocks-daily-v1-${{ github.ref_name }}-${{ github.run_id }}

      - name: Commit & push (panel_daily + docs)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${PANEL_DAILY_PATH}" || true
          git add docs/stocks || true

          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "stocks daily: update panel_daily + docs"
          git push
