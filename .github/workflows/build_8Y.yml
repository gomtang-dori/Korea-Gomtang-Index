name: build_8Y

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      PYTHONPATH: src

      # 8Y 정책
      ROLLING_DAYS: "1260"        # 5년 퍼센타일
      MIN_OBS: "252"
      WINSOR_P: "0.01"
      FACTOR_EMA_SPAN: "10"       # 팩터 EMA10
      INDEX_EMA_SPAN: "5"         # 최종 EMA5
      EXCLUDE_FACTORS: "f09"      # ✅ 8Y에서는 F09 제외
      LOOKBACK_DAYS: "2016" (8Y)

      # 산출물 분리
      INDEX_PATH: "data/index_daily_8Y.parquet"
      CSV_PATH: "data/index_daily_8Y.csv"
      REPORT_PATH: "docs/Korea-Gomtang-Index_8Y.html"
      INDEX_LEVELS_PATH: data/cache/index_levels.parquet
      FACTORS_DIR: data/factors
      EPS_FLAT: "0.002"
      REPORT_TITLE: "한국곰탕지수(1Y) 일일 리포트"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Re-calc factors (8Y = 5y percentile)
        shell: bash
        run: |
          set -euo pipefail
          python src/factors/f01_momentum.py
          python src/factors/f02_strength.py || true
          python src/factors/f03_adr_breadth.py || true
          python src/factors/f04_putcall.py
          python src/factors/f05_credit_spread.py
          python src/factors/f06_vkospi.py
          python src/factors/f07_safehaven.py
          python src/factors/f08_foreigner_flow.py
          python src/factors/f10_fxvol.py
          
      - name: Make final weights (8Y, KOSPI, group-sum + cap=0.25)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/make_final_weights.py
        env:
          PYTHONPATH: src
          POLICY: "8Y"
          CAP: "0.25"
          IN_WEIGHTS_CSV: "data/analysis/predict_h5_10_20_8Y_kospi_weights.csv"
          OUT_CSV: "data/analysis/final_weights_8Y_kospi.csv"
          
      - name: Assemble index (EMA10 + EMA5, exclude f09)
        shell: bash
        run: |
          set -euo pipefail
          python src/assemble/assemble_index.py
        env:
          WEIGHTS_CSV_PATH: "data/analysis/final_weights_8Y_kospi.csv"
          WEIGHTS_USED_OUT: "docs/weights_used_8Y.json"
          CONTRARIAN_SUFFIX: "_c"
          
      - name: ML prob_up_10d (XGBoost, KOSPI, horizon=10)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/train_xgb_prob_up10.py
        env:
          PYTHONPATH: src
          FACTORS_DIR: data/factors
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          TARGET_COL: kospi_close
          HORIZON_DAYS: "10"
          ADD_CONTRARIAN: "1"
          CONTRARIAN_SUFFIX: "_c"
          EXCLUDE_FACTORS: "f09"
          TAG: "8Y"
          OUT_PRED_PARQUET: data/analysis/prob_up_10d_8Y.parquet
          OUT_METRICS_CSV: data/analysis/ml_prob_up10_8Y_metrics.csv
          VKOSPI_LEVELS_PATH: data/cache/vkospi_level.parquet
          F08_FLOW_PATH: data/cache/f08_foreigner_flow.parquet
          USDKRW_PATH: data/usdkrw_level.parquet
          ADD_USDKRW_RET20: "1"          

      - name: Merge prob_up_10d into index parquet/csv (8Y)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/merge_prob_into_index.py
        env:
          PYTHONPATH: src
          INDEX_PATH: data/index_daily_8Y.parquet
          CSV_PATH: data/index_daily_8Y.csv
          PROB_PATH: data/analysis/prob_up_10d_8Y.parquet

      - name: Convert parquet to CSV (8Y)
        shell: bash
        run: |
          set -euo pipefail
          python src/parquet_to_csv.py

      - name: Render report (8Y)
        shell: bash
        run: |
          set -euo pipefail
          python src/report/render_report.py
          
      - name: Corr matrix (8Y) - scores + index levels (Pearson)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/corr_factors_plus_index.py
        env:
          PYTHONPATH: src
          CORR_METHOD: pearson
          USE_RETURNS: "0"
          EXCLUDE_FACTORS: f09
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_PATH: data/analysis/corr_8Y_scores_plus_index_levels_pearson.csv

      - name: Corr matrix (8Y) - scores + index returns (Pearson)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/corr_factors_plus_index.py
        env:
          PYTHONPATH: src
          CORR_METHOD: pearson
          USE_RETURNS: "1"
          EXCLUDE_FACTORS: f09
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_PATH: data/analysis/corr_8Y_scores_plus_index_returns_pearson.csv
          
      - name: Corr matrix + heatmap (8Y, levels)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/factor_corr_matrix.py
        env:
          PYTHONPATH: src
          TAG: 8Y
          MODE: levels
          CORR_METHOD: pearson
          EXCLUDE_FACTORS: f09
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_CSV: data/analysis/factor_corr_8Y_pearson_levels.csv
          OUT_HTML: docs/factor_corr_8Y_pearson_levels.html
          OUT_PNG: docs/factor_corr_8Y_pearson_levels.png
          SAVE_PNG: "1"

      - name: Corr matrix + heatmap (8Y, returns)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/factor_corr_matrix.py
        env:
          PYTHONPATH: src
          TAG: 8Y
          MODE: returns
          CORR_METHOD: pearson
          EXCLUDE_FACTORS: f09
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_CSV: data/analysis/factor_corr_8Y_pearson_returns.csv
          OUT_HTML: docs/factor_corr_8Y_pearson_returns.html
          OUT_PNG: docs/factor_corr_8Y_pearson_returns.png
          SAVE_PNG: "1"
          
      - name: Render corr index page
        shell: bash
        run: |
          set -euo pipefail
          python src/report/render_corr_index.py
          
      - name: Predictive power report (H=5,10,20; target=KOSPI; 8Y)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/predict_horizons_report.py
        env:
          PYTHONPATH: src
          TAG: "8Y"
          HORIZONS: "5,10,20"
          TARGET_INDEX: "kospi_close"
          EXCLUDE_FACTORS: "f09"
          ADD_CONTRARIAN: "1"
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_PREFIX: "predict_h5_10_20_8Y_kospi"
          OUT_DIR: "data/analysis"
          OUT_HTML: "docs/predict_h5_10_20_8Y_kospi.html"          

      - name: Render diagnostics page (8Y, last 180 days)
        shell: bash
        run: |
          set -euo pipefail
          python src/report/render_diagnostics.py
        env:
          PYTHONPATH: src
          TAG: "8Y"
          DAYS: "180"
          INDEX_PATH: "data/index_daily_8Y.parquet"
          ML_METRICS_PATH: "data/analysis/ml_prob_up10_8Y_metrics.csv"
          FINAL_WEIGHTS_PATH: "data/analysis/final_weights_8Y_kospi.csv"
          OUT_HTML: "docs/diagnostics_8Y.html"
          

      - name: Commit & push (if changed)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/analysis/ || true

          git add data/factors/ || true
          git add data/index_daily_8Y.parquet data/index_daily_8Y.csv || true
          git add docs/Korea-Gomtang-Index_8Y.html || true
          git add data/analysis/ || true
          git add docs/factor_corr_8Y_*.html docs/factor_corr_8Y_*.png || true
          git add docs/corr.html || true
          
          git add docs/predict_10d_report_*.html || true
          git add data/analysis/predict_h5_10_20_*.csv || true
          git add data/analysis/predict_h5_10_20_*_best_h*.csv || true
          git add docs/predict_h5_10_20_*.html || true
          git add data/analysis/final_weights_*.csv || true
          git add data/analysis/prob_up_10d_8Y.parquet data/analysis/ml_prob_up10_8Y_metrics.csv || true
          git add docs/diagnostics_8Y.html || true
          git add docs/weights_used_*.json || true

          # git add data/analysis/predict_10d_metrics_*.csv || true

          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Build 8Y index (EMA10/EMA5, 5y percentile) $(date -u +%Y-%m-%d)"

          git stash push -u -m actions-stash-before-rebase || true
          git fetch origin main
          git pull --rebase origin main
          git stash pop || true

          git push origin HEAD:main
