name: DART Backfill (Raw Cache + Audit)

on:
  workflow_dispatch:
    inputs:
      year_from:
        description: "Start year (YYYY)"
        type: string
        default: "2015"
      year_to:
        description: "End year (YYYY)"
        type: string
        default: "2017"
      reprt_codes:
        description: "Report codes (11011,11012,11013,11014)"
        type: string
        default: "11011,11012,11013,11014"
      dart_max_workers:
        description: "DART workers (3~6 recommended)"
        type: string
        default: "5"
      dart_min_interval_sec:
        description: "Global request min interval seconds"
        type: string
        default: "0.15"
      dart_run_budget:
        description: "Max calls in this run (safety)"
        type: string
        default: "38000"
      cache_mode:
        description: "skip or overwrite"
        type: string
        default: "skip"
      run_curate:
        description: "Run curate_dart.py after fetch"
        type: boolean
        default: false

jobs:
  dart_backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 210  # 약 3.5시간
    env:
      DART_API_KEY:  ${{ secrets.DART_API_KEY }}
      DART_API2_KEY: ${{ secrets.DART_API2_KEY }}
      DART_YEAR_FROM: ${{ inputs.year_from }}
      DART_YEAR_TO: ${{ inputs.year_to }}
      DART_REPRT_CODES: ${{ inputs.reprt_codes }}
      DART_MAX_WORKERS: ${{ inputs.dart_max_workers }}
      DART_MIN_INTERVAL_SEC: ${{ inputs.dart_min_interval_sec }}
      DART_RUN_BUDGET: ${{ inputs.dart_run_budget }}
      DART_CACHE_MODE: ${{ inputs.cache_mode }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install pandas pyarrow requests

      - name: Fetch DART raw cache
        continue-on-error: true
        run: |
          python src/stocks/fetch_dart_financials.py || echo "⚠️ DART fetch 일부 오류"

      - name: Export audit CSV (verify reprt_code/year/status)
        if: always()
        continue-on-error: true
        run: |
          python src/stocks/export_dart_audit_csv.py || echo "⚠️ audit csv 생성 오류"

      - name: (Optional) Curate to parquet/csv
        if: ${{ inputs.run_curate }}
        continue-on-error: true
        run: |
          python src/stocks/curate_dart.py || echo "⚠️ curate_dart 오류"

      - name: Compress raw dart cache
        if: always()
        continue-on-error: true
        run: |
          tar -czf dart_raw_${{ inputs.year_from }}_${{ inputs.year_to }}.tar.gz data/stocks/raw/dart 2>/dev/null || true
          ls -lh dart_raw_${{ inputs.year_from }}_${{ inputs.year_to }}.tar.gz 2>/dev/null || true

      - name: Upload raw dart artifact (retention 90d)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dart-raw-${{ inputs.year_from }}-${{ inputs.year_to }}
          path: dart_raw_${{ inputs.year_from }}_${{ inputs.year_to }}.tar.gz
          retention-days: 90
          if-no-files-found: warn

      - name: Upload audit artifact (retention 90d)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dart-audit-${{ inputs.year_from }}-${{ inputs.year_to }}
          path: docs/stocks/dart_audit_${{ inputs.year_from }}_${{ inputs.year_to }}.csv
          retention-days: 90
          if-no-files-found: warn

      - name: Upload standard curated CSV (if created)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dart-standard-${{ inputs.year_from }}-${{ inputs.year_to }}
          path: docs/stocks/dart_standard_${{ inputs.year_from }}_${{ inputs.year_to }}.csv
          retention-days: 90
          if-no-files-found: warn
