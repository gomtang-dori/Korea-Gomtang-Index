name: DART Backfill (Raw Cache + Audit)

on:
  workflow_dispatch:
    inputs:
      year_from:
        description: "Start year (YYYY)"
        type: string
        default: "2015"
      year_to:
        description: "End year (YYYY)"
        type: string
        default: "2017"
      reprt_codes:
        description: "Report codes (11011,11012,11013,11014)"
        type: string
        default: "11011,11012,11013,11014"
      dart_max_workers:
        description: "DART workers (3~6 recommended)"
        type: string
        default: "5"
      dart_min_interval_sec:
        description: "Global request min interval seconds"
        type: string
        default: "0.15"
      dart_run_budget:
        description: "Max calls in this run (safety)"
        type: string
        default: "38000"
      cache_mode:
        description: "skip or overwrite"
        type: string
        default: "skip"
      run_curate:
        description: "Run curate_dart.py after fetch"
        type: boolean
        default: false

jobs:
  dart_backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 약 3.5시간
    env:
      DART_API_KEY:  ${{ secrets.DART_API_KEY }}
      DART_API2_KEY: ${{ secrets.DART_API2_KEY }}
      DART_YEAR_FROM: ${{ inputs.year_from }}
      DART_YEAR_TO: ${{ inputs.year_to }}
      DART_REPRT_CODES: ${{ inputs.reprt_codes }}
      DART_MAX_WORKERS: ${{ inputs.dart_max_workers }}
      DART_MIN_INTERVAL_SEC: ${{ inputs.dart_min_interval_sec }}
      DART_RUN_BUDGET: ${{ inputs.dart_run_budget }}
      DART_CACHE_MODE: ${{ inputs.cache_mode }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install pandas pyarrow requests pykrx

      - name: "[사전] Fetch FULL listings (force SAMPLE_MODE=false)"
        continue-on-error: true
        env:
          SAMPLE_MODE: "false"
        run: |
          python src/stocks/fetch_listings.py || echo "⚠️ fetch_listings 오류"
          python - << 'PY'
          import pandas as pd
          df = pd.read_parquet("data/stocks/master/listings.parquet")
          print(f"[listings] rows={len(df):,}, unique_tickers={df['ticker'].astype(str).nunique():,}")
          print(df.head(3))
          PY
        
      - name: "[검증] listings 행 수 + 예상 DART jobs(call) 계산"
        if: always()
        run: |
          python - << 'PY'
          import os
          from pathlib import Path
          import pandas as pd

          listings_path = Path("data/stocks/master/listings.parquet")

          year_from = int(os.getenv("DART_YEAR_FROM", "0") or 0)
          year_to   = int(os.getenv("DART_YEAR_TO", "0") or 0)
          years_cnt = max(0, year_to - year_from + 1)

          codes = [c.strip() for c in os.getenv("DART_REPRT_CODES", "").split(",") if c.strip()]
          codes_cnt = len(codes)

          # key count (secrets are injected as env)
          key1 = (os.getenv("DART_API_KEY", "") or "").strip()
          key2 = (os.getenv("DART_API2_KEY", "") or "").strip()
          keys_cnt = 0
          if key1:
            keys_cnt += 1
          if key2:
            keys_cnt += 1

          # budget (current workflow sets DART_RUN_BUDGET; fetch script treats it as per-key budget)
          budget_per_key = int(os.getenv("DART_RUN_BUDGET", "0") or 0)
          total_budget = budget_per_key * max(keys_cnt, 1)

          print("[verify] ===== DART backfill precheck =====")
          print(f"[verify] years={year_from}..{year_to} (count={years_cnt})")
          print(f"[verify] reprt_codes={codes} (count={codes_cnt})")
          print(f"[verify] keys_cnt={keys_cnt} (DART_API_KEY={'Y' if bool(key1) else 'N'}, DART_API2_KEY={'Y' if bool(key2) else 'N'})")
          print(f"[verify] budget_per_key(DART_RUN_BUDGET)={budget_per_key:,}")
          print(f"[verify] total_budget_estimate=budget_per_key*keys_cnt={total_budget:,}")

          if not listings_path.exists():
            print(f"[verify][WARN] MISSING: {listings_path}")
            print("[verify][WARN] listings가 없으면 실제 jobs 계산/수집 대상이 매우 작아질 수 있습니다.")
            raise SystemExit(0)

          df = pd.read_parquet(listings_path)
          rows = len(df)
          if "ticker" in df.columns:
            uniq = df["ticker"].astype(str).nunique()
          else:
            uniq = rows

          print(f"[verify] listings rows={rows:,}, unique_tickers={uniq:,}")

          if years_cnt == 0 or codes_cnt == 0:
            print("[verify][WARN] years_cnt 또는 codes_cnt가 0입니다. 입력값(year_from/to, reprt_codes)을 확인하세요.")
            raise SystemExit(0)

          expected_jobs = uniq * years_cnt * codes_cnt
          print(f"[verify] expected_jobs_estimate ~= {expected_jobs:,} (=unique_tickers*years*reprt_codes)")

          # budget sanity check
          if budget_per_key > 0:
            margin = total_budget - expected_jobs
            print(f"[verify] margin(total_budget - expected_jobs) = {margin:,}")
            if expected_jobs > total_budget:
              print("[verify][WARN] expected_jobs > total_budget -> 이번 run에서 cap에 걸려 중간 종료될 가능성이 큽니다.")
              print("[verify][HINT] 해결: (1) 연도 구간 축소 (2) reprt_codes 축소 (3) budget 상향 (4) cache_mode=skip로 누락분만")
          print("[verify] =================================")
          PY
        

      - name: Fetch DART raw cache
        continue-on-error: true
        run: |
          python src/stocks/fetch_dart_financials.py || echo "⚠️ DART fetch 일부 오류"

      - name: Export audit CSV (verify reprt_code/year/status)
        if: always()
        continue-on-error: true
        run: |
          python src/stocks/export_dart_audit_csv.py || echo "⚠️ audit csv 생성 오류"

      - name: (Optional) Curate to parquet/csv
        if: ${{ inputs.run_curate }}
        continue-on-error: true
        run: |
          python src/stocks/curate_dart.py || echo "⚠️ curate_dart 오류"

      - name: Compress raw dart cache
        if: always()
        continue-on-error: true
        run: |
          tar -czf dart_raw_${{ inputs.year_from }}_${{ inputs.year_to }}.tar.gz data/stocks/raw/dart 2>/dev/null || true
          ls -lh dart_raw_${{ inputs.year_from }}_${{ inputs.year_to }}.tar.gz 2>/dev/null || true

      - name: Upload raw dart artifact (retention 90d)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dart-raw-${{ inputs.year_from }}-${{ inputs.year_to }}
          path: dart_raw_${{ inputs.year_from }}_${{ inputs.year_to }}.tar.gz
          retention-days: 90
          if-no-files-found: warn

      - name: Upload audit artifact (retention 90d)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dart-audit-${{ inputs.year_from }}-${{ inputs.year_to }}
          path: docs/stocks/dart_audit_${{ inputs.year_from }}_${{ inputs.year_to }}.csv
          retention-days: 90
          if-no-files-found: warn

      - name: Upload standard curated CSV (if created)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dart-standard-${{ inputs.year_from }}-${{ inputs.year_to }}
          path: docs/stocks/dart_standard_${{ inputs.year_from }}_${{ inputs.year_to }}.csv
          retention-days: 90
          if-no-files-found: warn
