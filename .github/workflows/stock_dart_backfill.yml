name: DART Backfill (Raw Cache + Audit + Monthly Curate/Commit)

on:
  workflow_dispatch:
    inputs:
      year_from:
        description: "Start year (YYYY)"
        type: string
        default: "2015"
      year_to:
        description: "End year (YYYY)"
        type: string
        default: "2017"

      reprt_codes:
        description: "Report codes (11011,11012,11013,11014). You can split runs by codes."
        type: string
        default: "11011,11012,11013,11014"

      # 안전 추천 기본값(보수적)
      dart_max_workers:
        description: "DART workers (3~6 recommended). Rate limiter is global."
        type: string
        default: "4"
      dart_min_interval_sec:
        description: "Global request min interval seconds (safety). 0.25~0.35 recommended."
        type: string
        default: "0.30"

      dart_run_budget:
        description: "Max calls per key in this run (safety). If 2 keys, total budget ~= 2x."
        type: string
        default: "25000"

      cache_mode:
        description: "skip or overwrite"
        type: string
        default: "skip"

      # 캐시 분할/유지 전략
      cache_namespace:
        description: "Cache namespace. Use 'global' or a segment label (e.g., '2022-2024')."
        type: string
        default: "global"

      prune_before_cache_save:
        description: "If true, prune old years before saving cache (keeps cache small)."
        type: boolean
        default: false

      retain_years_in_cache:
        description: "When prune enabled, keep only last N years (based on year_to)."
        type: string
        default: "5"

      max_cache_size_mb:
        description: "If cache dir exceeds this size, prune (if enabled) or skip cache save. 0=ignore."
        type: string
        default: "0"

      run_curate:
        description: "Run curate_dart.py after fetch (manual only; schedule forces true)"
        type: boolean
        default: false

  schedule:
    # 매월 15일 18:00 KST = 09:00 UTC
    - cron: "0 9 15 * *"

permissions:
  contents: write

jobs:
  dart_backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      DART_API_KEY:  ${{ secrets.DART_API_KEY }}
      DART_API2_KEY: ${{ secrets.DART_API2_KEY }}

      # 아래 값들은 "Resolve schedule/manual settings" step에서 최종 확정(GITHUB_ENV로 override)
      DART_YEAR_FROM: "2015"
      DART_YEAR_TO: "2017"
      DART_REPRT_CODES: "11011,11012,11013,11014"

      DART_MAX_WORKERS: "4"
      DART_MIN_INTERVAL_SEC: "0.30"
      DART_RUN_BUDGET: "25000"
      DART_CACHE_MODE: "skip"

      CACHE_NAMESPACE: "global"
      PRUNE_BEFORE_CACHE_SAVE: "false"
      RETAIN_YEARS_IN_CACHE: "5"
      MAX_CACHE_SIZE_MB: "0"

      # curate control (schedule에서 true로 강제)
      RUN_CURATE: "false"

      # curate_dart standard csv (schedule에서 true로 강제)
      DART_STANDARD_FULL_RANGE: "false"
      DART_STANDARD_FULL_YEAR_FROM: "2015"
      DART_STANDARD_FULL_YEAR_TO: "2026"
      DART_WRITE_STANDARD_CSV: "true"
      DART_CURATE_MODE: "upsert_slice"

      # schedule에서 standard csv를 커밋/푸시할지
      COMMIT_DART_STANDARD: "false"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install pandas pyarrow requests pykrx tabulate

      - name: Sanity check (tabulate)
        run: |
          python -c "import tabulate; print('tabulate=', tabulate.__version__)"

      # ============================================================
      # Resolve schedule/manual settings
      # - schedule: run_curate=true + full-range standard csv 생성 + 커밋
      # - manual: inputs 값 사용 (run_curate는 입력값 그대로)
      # ============================================================
      - name: Resolve schedule/manual settings
        run: |
          set -euo pipefail

          EVENT="${{ github.event_name }}"
          echo "[mode] event_name=${EVENT}"

          if [ "${EVENT}" = "schedule" ]; then
            # 스케줄: 매월 15일 18:00 KST에 실행됨
            # - 매번 전체(2015~2026)를 다시 긁기보단 최근 3년 정도 slice만 새로 받아 누적 cache에 upsert
            YEAR_TO="$(date -u +%Y)"
            YEAR_FROM="$((YEAR_TO-2))"

            echo "DART_YEAR_FROM=${YEAR_FROM}" >> $GITHUB_ENV
            echo "DART_YEAR_TO=${YEAR_TO}" >> $GITHUB_ENV
            echo "DART_REPRT_CODES=11011,11012,11013,11014" >> $GITHUB_ENV

            echo "RUN_CURATE=true" >> $GITHUB_ENV
            echo "DART_STANDARD_FULL_RANGE=true" >> $GITHUB_ENV
            echo "DART_STANDARD_FULL_YEAR_FROM=2015" >> $GITHUB_ENV
            echo "DART_STANDARD_FULL_YEAR_TO=2026" >> $GITHUB_ENV

            echo "COMMIT_DART_STANDARD=true" >> $GITHUB_ENV
          else
            # 수동 실행(workflow_dispatch): inputs 기반
            YEAR_FROM="${{ github.event.inputs.year_from }}"
            YEAR_TO="${{ github.event.inputs.year_to }}"
            CODES="${{ github.event.inputs.reprt_codes }}"
            MAXW="${{ github.event.inputs.dart_max_workers }}"
            MININT="${{ github.event.inputs.dart_min_interval_sec }}"
            BUDGET="${{ github.event.inputs.dart_run_budget }}"
            CACHEMODE="${{ github.event.inputs.cache_mode }}"
            NS="${{ github.event.inputs.cache_namespace }}"
            PRUNE="${{ github.event.inputs.prune_before_cache_save }}"
            RETAIN="${{ github.event.inputs.retain_years_in_cache }}"
            MAXMB="${{ github.event.inputs.max_cache_size_mb }}"
            RUNCUR="${{ github.event.inputs.run_curate }}"

            [ -z "${YEAR_FROM}" ] && YEAR_FROM="2015"
            [ -z "${YEAR_TO}" ] && YEAR_TO="2017"
            [ -z "${CODES}" ] && CODES="11011,11012,11013,11014"
            [ -z "${MAXW}" ] && MAXW="4"
            [ -z "${MININT}" ] && MININT="0.30"
            [ -z "${BUDGET}" ] && BUDGET="25000"
            [ -z "${CACHEMODE}" ] && CACHEMODE="skip"
            [ -z "${NS}" ] && NS="global"
            [ -z "${PRUNE}" ] && PRUNE="false"
            [ -z "${RETAIN}" ] && RETAIN="5"
            [ -z "${MAXMB}" ] && MAXMB="0"
            [ -z "${RUNCUR}" ] && RUNCUR="false"

            echo "DART_YEAR_FROM=${YEAR_FROM}" >> $GITHUB_ENV
            echo "DART_YEAR_TO=${YEAR_TO}" >> $GITHUB_ENV
            echo "DART_REPRT_CODES=${CODES}" >> $GITHUB_ENV

            echo "DART_MAX_WORKERS=${MAXW}" >> $GITHUB_ENV
            echo "DART_MIN_INTERVAL_SEC=${MININT}" >> $GITHUB_ENV
            echo "DART_RUN_BUDGET=${BUDGET}" >> $GITHUB_ENV
            echo "DART_CACHE_MODE=${CACHEMODE}" >> $GITHUB_ENV

            echo "CACHE_NAMESPACE=${NS}" >> $GITHUB_ENV
            echo "PRUNE_BEFORE_CACHE_SAVE=${PRUNE}" >> $GITHUB_ENV
            echo "RETAIN_YEARS_IN_CACHE=${RETAIN}" >> $GITHUB_ENV
            echo "MAX_CACHE_SIZE_MB=${MAXMB}" >> $GITHUB_ENV

            # manual에서 curate를 돌리는 경우에만 full-range 표준 CSV도 생성하도록 기본값 ON 권장
            if [ "${RUNCUR}" = "true" ]; then
              echo "RUN_CURATE=true" >> $GITHUB_ENV
              echo "DART_STANDARD_FULL_RANGE=true" >> $GITHUB_ENV
              echo "DART_STANDARD_FULL_YEAR_FROM=2015" >> $GITHUB_ENV
              echo "DART_STANDARD_FULL_YEAR_TO=2026" >> $GITHUB_ENV
            else
              echo "RUN_CURATE=false" >> $GITHUB_ENV
              echo "DART_STANDARD_FULL_RANGE=false" >> $GITHUB_ENV
            fi

            echo "COMMIT_DART_STANDARD=false" >> $GITHUB_ENV
          fi

          echo "[resolved]"
          echo "  DART_YEAR_FROM=${DART_YEAR_FROM:-unset}"
          echo "  DART_YEAR_TO=${DART_YEAR_TO:-unset}"
          echo "  DART_REPRT_CODES=${DART_REPRT_CODES:-unset}"
          echo "  RUN_CURATE=${RUN_CURATE:-unset}"
          echo "  DART_STANDARD_FULL_RANGE=${DART_STANDARD_FULL_RANGE:-unset}"
          echo "  COMMIT_DART_STANDARD=${COMMIT_DART_STANDARD:-unset}"

      # ------------------------------------------------------------
      # Restore DART raw cache (누적 목적)
      # ------------------------------------------------------------
      - name: Restore DART raw cache (actions/cache)
        id: dart_cache_restore
        uses: actions/cache/restore@v4
        with:
          path: |
            data/stocks/raw/dart
          key: dart-raw-v1-${{ github.ref_name }}-${{ env.CACHE_NAMESPACE }}-${{ github.run_id }}
          restore-keys: |
            dart-raw-v1-${{ github.ref_name }}-${{ env.CACHE_NAMESPACE }}-
            dart-raw-v1-${{ github.ref_name }}-

      - name: Show cache restore result
        run: |
          echo "[cache] restore hit? -> ${{ steps.dart_cache_restore.outputs.cache-hit }}"
          echo "[cache] namespace=${CACHE_NAMESPACE}"
          ls -lah data/stocks/raw/dart || true
          python - << 'PY'
          from pathlib import Path
          raw = Path("data/stocks/raw/dart")
          if not raw.exists():
            print("[cache] raw dir missing")
            raise SystemExit(0)
          ticker_dirs = [p for p in raw.iterdir() if p.is_dir() and p.name.isdigit() and len(p.name)==6]
          print(f"[cache] raw_ticker_dirs={len(ticker_dirs):,}")
          PY

      - name: "[사전] Fetch FULL listings (force SAMPLE_MODE=false)"
        continue-on-error: true
        env:
          SAMPLE_MODE: "false"
        run: |
          python src/stocks/fetch_listings.py || echo "⚠️ fetch_listings 오류"
          python - << 'PY'
          import pandas as pd
          df = pd.read_parquet("data/stocks/master/listings.parquet")
          print(f"[listings] rows={len(df):,}, unique_tickers={df['ticker'].astype(str).nunique():,}")
          print(df.head(3))
          PY

      - name: Fetch DART raw cache
        continue-on-error: true
        run: |
          echo "[dart] range=${DART_YEAR_FROM}..${DART_YEAR_TO} codes=${DART_REPRT_CODES}"
          python src/stocks/fetch_dart_financials.py || echo "⚠️ DART fetch 일부 오류"

      - name: Export audit CSV (verify reprt_code/year/status)
        if: always()
        continue-on-error: true
        run: |
          python src/stocks/export_dart_audit_csv.py || echo "⚠️ audit csv 생성 오류"

      # ------------------------------------------------------------
      # Curate to build standard CSV (schedule forces RUN_CURATE=true)
      # ------------------------------------------------------------
      - name: Curate DART (make dart_standard CSV)
        if: ${{ env.RUN_CURATE == 'true' }}
        continue-on-error: true
        run: |
          echo "[curate] running curate_dart.py ..."
          python src/stocks/curate_dart.py || echo "⚠️ curate_dart 오류"
          ls -lh docs/stocks/dart_standard_*.csv 2>/dev/null || true

      # ------------------------------------------------------------
      # Save DART raw cache
      # ------------------------------------------------------------
      - name: Save DART raw cache (actions/cache)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            data/stocks/raw/dart
          key: dart-raw-v1-${{ github.ref_name }}-${{ env.CACHE_NAMESPACE }}-${{ github.run_id }}

      # ------------------------------------------------------------
      # Commit dart_standard CSV on schedule (so panel mart sees it via checkout)
      # ------------------------------------------------------------
      - name: Commit & push dart_standard CSV (schedule)
        if: ${{ env.COMMIT_DART_STANDARD == 'true' }}
        continue-on-error: true
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # full-range standard CSV (used by panel)
          git add docs/stocks/dart_standard_*.csv || true

          git diff --cached --quiet && echo "No dart_standard changes" && exit 0
          git commit -m "dart: update dart_standard CSV (monthly scheduled)"
          git push

      - name: Upload standard CSV artifact (retention 90d)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dart-standard-csv
          path: |
            docs/stocks/dart_standard_*.csv
          retention-days: 90
          if-no-files-found: warn
