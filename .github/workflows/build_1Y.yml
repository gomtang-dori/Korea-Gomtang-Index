name: build_1Y

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      PYTHONPATH: src
      ROLLING_DAYS: "252"
      MIN_OBS: "60"
      WINSOR_P: "0.01"
      FACTOR_EMA_SPAN: "20"
      INDEX_EMA_SPAN: "5"
      EXCLUDE_FACTORS: ""
      INDEX_PATH: "data/index_daily_1Y.parquet"
      CSV_PATH: "data/index_daily_1Y.csv"
      REPORT_PATH: "docs/Korea-Gomtang-Index_1Y.html"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Calc factors
        run: |
          python src/factors/f01_momentum.py
          python src/factors/f02_strength.py || true
          python src/factors/f03_adr_breadth.py || true
          python src/factors/f04_putcall.py
          python src/factors/f05_credit_spread.py
          python src/factors/f06_vkospi.py
          python src/factors/f07_safehaven.py
          python src/factors/f08_foreigner_flow.py
          python src/factors/f09_margin_ratio.py || true
          python src/factors/f10_fxvol.py

      - name: Assemble
        run: |
          python src/assemble/assemble_index.py

      - name: To CSV
        run: |
          python src/parquet_to_csv.py

      - name: Report
        run: |
          python src/report/render_report.py
      - name: Corr matrix (1Y) - scores + index levels (Pearson)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/corr_factors_plus_index.py
        env:
          PYTHONPATH: src
          CORR_METHOD: pearson
          USE_RETURNS: "0"
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_PATH: data/analysis/corr_1Y_scores_plus_index_levels_pearson.csv

      - name: Corr matrix (1Y) - scores + index returns (Pearson)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/corr_factors_plus_index.py
        env:
          PYTHONPATH: src
          CORR_METHOD: pearson
          USE_RETURNS: "1"
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_PATH: data/analysis/corr_1Y_scores_plus_index_returns_pearson.csv
          
      - name: Corr matrix + heatmap (1Y, levels)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/factor_corr_matrix.py
        env:
          PYTHONPATH: src
          TAG: 1Y
          MODE: levels
          CORR_METHOD: pearson
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_CSV: data/analysis/factor_corr_1Y_pearson_levels.csv
          OUT_HTML: docs/factor_corr_1Y_pearson_levels.html
          OUT_PNG: docs/factor_corr_1Y_pearson_levels.png
          SAVE_PNG: "1"

      - name: Corr matrix + heatmap (1Y, returns)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/factor_corr_matrix.py
        env:
          PYTHONPATH: src
          TAG: 1Y
          MODE: returns
          CORR_METHOD: pearson
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_CSV: data/analysis/factor_corr_1Y_pearson_returns.csv
          OUT_HTML: docs/factor_corr_1Y_pearson_returns.html
          OUT_PNG: docs/factor_corr_1Y_pearson_returns.png
          SAVE_PNG: "1"

      - name: Commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/factors/ || true
          git add data/index_daily_1Y.parquet data/index_daily_1Y.csv || true
          git add docs/Korea-Gomtang-Index_1Y.html || true
          git add data/analysis/ || true
          git add data/analysis/ || true
          git add docs/factor_corr_1Y_*.html docs/factor_corr_1Y_*.png || true
          
          if git diff --staged --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "Build 1Y index $(date -u +%Y-%m-%d)"
          git stash push -u -m actions-stash-before-rebase || true
          git fetch origin main
          git pull --rebase origin main
          git stash pop || true
          git push origin HEAD:main
