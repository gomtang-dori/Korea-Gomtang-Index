name: build_1Y

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      PYTHONPATH: src
      ROLLING_DAYS: "252"
      MIN_OBS: "60"
      WINSOR_P: "0.01"
      FACTOR_EMA_SPAN: "20"
      INDEX_EMA_SPAN: "5"
      EXCLUDE_FACTORS: ""
      INDEX_PATH: "data/index_daily_1Y.parquet"
      CSV_PATH: "data/index_daily_1Y.csv"
      REPORT_PATH: "docs/Korea-Gomtang-Index_1Y.html"
      LOOKBACK_DAYS: "252"
      INDEX_LEVELS_PATH: data/cache/index_levels.parquet
      FACTORS_DIR: data/factors
      EPS_FLAT: "0.002"
      REPORT_TITLE: "한국곰탕지수(1Y) 일일 리포트"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Calc factors
        run: |
          python src/factors/f01_momentum.py
          python src/factors/f02_strength.py || true
          python src/factors/f03_adr_breadth.py || true
          python src/factors/f04_putcall.py
          python src/factors/f05_credit_spread.py
          python src/factors/f06_vkospi.py
          python src/factors/f07_safehaven.py
          python src/factors/f08_foreigner_flow.py
          python src/factors/f09_margin_ratio.py || true
          python src/factors/f10_fxvol.py
          
      - name: Make final weights (1Y, KOSPI, group-sum + cap=0.25)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/make_final_weights.py
        env:
          PYTHONPATH: src
          POLICY: "1Y"
          CAP: "0.25"
          IN_WEIGHTS_CSV: "data/analysis/predict_h5_10_20_1Y_kospi_weights.csv"
          OUT_CSV: "data/analysis/final_weights_1Y_kospi.csv"
          
      - name: Assemble
        run: |
          python src/assemble/assemble_index.py
        env:
          WEIGHTS_CSV_PATH: "data/analysis/final_weights_1Y_kospi.csv"
          WEIGHTS_USED_OUT: "docs/weights_used_1Y.json"
          CONTRARIAN_SUFFIX: "_c"
          
      - name: ML prob_up_10d (XGBoost, KOSPI, horizon=10)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/train_xgb_prob_up10.py
        env:
          PYTHONPATH: src
          FACTORS_DIR: data/factors
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          TARGET_COL: kospi_close
          HORIZON_DAYS: "10"
          ADD_CONTRARIAN: "1"
          CONTRARIAN_SUFFIX: "_c"
          EXCLUDE_FACTORS: ""
          TAG: "1Y"
          OUT_PRED_PARQUET: data/analysis/prob_up_10d_1Y.parquet
          OUT_METRICS_CSV: data/analysis/ml_prob_up10_1Y_metrics.csv
          VKOSPI_LEVELS_PATH: data/cache/vkospi_level.parquet
          F08_FLOW_PATH: data/cache/f08_foreigner_flow.parquet
          USDKRW_PATH: data/usdkrw_level.parquet
          ADD_USDKRW_RET20: "0"

      - name: Merge prob_up_10d into index parquet/csv (1Y)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/merge_prob_into_index.py
        env:
          PYTHONPATH: src
          INDEX_PATH: data/index_daily_1Y.parquet
          CSV_PATH: data/index_daily_1Y.csv
          PROB_PATH: data/analysis/prob_up_10d_1Y.parquet

      - name: Sanity check prob_up_10d merged (1Y)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import pandas as pd
          df = pd.read_parquet("data/index_daily_1Y.parquet")
          print("prob_up_10d in cols:", "prob_up_10d" in df.columns)
          if "prob_up_10d" in df.columns:
            s = df["prob_up_10d"]
            print("non-null:", int(s.notna().sum()), "min:", float(s.min()), "max:", float(s.max()))
            print("last_non_null_date:", df.loc[s.notna(),"date"].iloc[-1])
          PY
          
      - name: Report (1Y)
        shell: bash
        run: |
          set -euo pipefail
          python src/report/render_report.py
        env:
          PYTHONPATH: src
          INDEX_PATH: data/index_daily_1Y.parquet
          REPORT_PATH: docs/Korea-Gomtang-Index_1Y.html
          LOOKBACK_DAYS: "252"
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          FACTORS_DIR: data/factors
          EPS_FLAT: "0.002"
          REPORT_TITLE: "한국곰탕지수(1Y) 일일 리포트"
          SCORE_FLAT_PTS: "1.0"
          HEATMAP_FONT_SIZE: "16"

          
      - name: To CSV
        run: |
          python src/parquet_to_csv.py

      - name: Report
        run: |
          python src/report/render_report.py
      - name: Corr matrix (1Y) - scores + index levels (Pearson)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/corr_factors_plus_index.py
        env:
          PYTHONPATH: src
          CORR_METHOD: pearson
          USE_RETURNS: "0"
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_PATH: data/analysis/corr_1Y_scores_plus_index_levels_pearson.csv

      - name: Corr matrix (1Y) - scores + index returns (Pearson)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/corr_factors_plus_index.py
        env:
          PYTHONPATH: src
          CORR_METHOD: pearson
          USE_RETURNS: "1"
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_PATH: data/analysis/corr_1Y_scores_plus_index_returns_pearson.csv
          
      - name: Corr matrix + heatmap (1Y, levels)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/factor_corr_matrix.py
        env:
          PYTHONPATH: src
          TAG: 1Y
          MODE: levels
          CORR_METHOD: pearson
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_CSV: data/analysis/factor_corr_1Y_pearson_levels.csv
          OUT_HTML: docs/factor_corr_1Y_pearson_levels.html
          OUT_PNG: docs/factor_corr_1Y_pearson_levels.png
          SAVE_PNG: "1"

      - name: Corr matrix + heatmap (1Y, returns)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/factor_corr_matrix.py
        env:
          PYTHONPATH: src
          TAG: 1Y
          MODE: returns
          CORR_METHOD: pearson
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_CSV: data/analysis/factor_corr_1Y_pearson_returns.csv
          OUT_HTML: docs/factor_corr_1Y_pearson_returns.html
          OUT_PNG: docs/factor_corr_1Y_pearson_returns.png
          SAVE_PNG: "1"
          
      - name: Render corr index page
        shell: bash
        run: |
          set -euo pipefail
          python src/report/render_corr_index.py
          
      - name: Predictive power report (H=5,10,20; target=KOSPI; 1Y)
        shell: bash
        run: |
          set -euo pipefail
          python src/analysis/predict_horizons_report.py
        env:
          PYTHONPATH: src
          TAG: "1Y"
          HORIZONS: "5,10,20"
          TARGET_INDEX: "kospi_close"
          EXCLUDE_FACTORS: ""
          ADD_CONTRARIAN: "1"
          INDEX_LEVELS_PATH: data/cache/index_levels.parquet
          OUT_PREFIX: "predict_h5_10_20_1Y_kospi"
          OUT_DIR: "data/analysis"
          OUT_HTML: "docs/predict_h5_10_20_1Y_kospi.html"          
          
      - name: Render diagnostics page (1Y, last 180 days)
        shell: bash
        run: |
          set -euo pipefail
          python src/report/render_diagnostics.py
        env:
          PYTHONPATH: src
          TAG: "1Y"
          DAYS: "180"
          INDEX_PATH: "data/index_daily_1Y.parquet"
          ML_METRICS_PATH: "data/analysis/ml_prob_up10_1Y_metrics.csv"
          FINAL_WEIGHTS_PATH: "data/analysis/final_weights_1Y_kospi.csv"
          OUT_HTML: "docs/diagnostics_1Y.html"

          

      - name: Commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/factors/ || true
          git add data/index_daily_1Y.parquet data/index_daily_1Y.csv || true
          git add docs/Korea-Gomtang-Index_1Y.html || true
          git add data/analysis/ || true
          git add data/analysis/ || true
          git add docs/factor_corr_1Y_*.html docs/factor_corr_1Y_*.png || true
          git add docs/corr.html || true
          git add docs/predict_10d_report_*.html || true
          git add data/analysis/predict_h5_10_20_*.csv || true
          git add data/analysis/predict_h5_10_20_*_best_h*.csv || true
          git add docs/predict_h5_10_20_*.html || true
          # git add data/analysis/predict_10d_metrics_*.csv || true
          git add data/analysis/final_weights_*.csv || true
          git add data/analysis/prob_up_10d_1Y.parquet data/analysis/ml_prob_up10_1Y_metrics.csv || true
          git add docs/diagnostics_1Y.html || true       
          git add docs/weights_used_*.json || true
          
          
          if git diff --staged --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "Build 1Y index $(date -u +%Y-%m-%d)"
          git stash push -u -m actions-stash-before-rebase || true
          git fetch origin main
          git pull --rebase origin main
          git stash pop || true
          git push origin HEAD:main
